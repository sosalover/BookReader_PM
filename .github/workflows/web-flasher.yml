name: Build & publish web flasher assets

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Code/PocketMage_V3

    steps:
      - name: Conjure the Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO + esptool + jq
        run: |
          set -euo pipefail
          pip install -U platformio esptool
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build firmware
        run: |
          set -euo pipefail
          pio run -e PM_V3
          echo "Build directory contents:"
          ls -lh .pio/build/PM_V3/*.bin

      - name: Extract partition offsets
        id: offsets
        run: |
          set -euo pipefail
          
          # Read offsets from partition CSV
          APP0_OFFSET=$(grep "^app0," partitions_4APP.csv | cut -d',' -f4 | tr -d ' ')
          PARTITIONS_OFFSET="0x8000"  # Standard for ESP32
          
          echo "bootloader_offset=0x0" >> $GITHUB_OUTPUT
          echo "partitions_offset=$PARTITIONS_OFFSET" >> $GITHUB_OUTPUT
          echo "app0_offset=$APP0_OFFSET" >> $GITHUB_OUTPUT
          
          echo "Partition offsets:"
          echo "  Bootloader: 0x0"
          echo "  Partitions: $PARTITIONS_OFFSET"
          echo "  App0: $APP0_OFFSET"

      - name: Determine flash parameters from board config
        id: flash_params
        run: |
          set -euo pipefail
          
          # Extract flash mode and freq from platformio.ini or use sensible defaults for ESP32-S3
          # ESP32-S3 typically uses QIO/DIO mode and 80MHz
          FLASH_MODE="dio"
          FLASH_FREQ="80m"
          FLASH_SIZE="16MB"
          
          echo "flash_mode=$FLASH_MODE" >> $GITHUB_OUTPUT
          echo "flash_freq=$FLASH_FREQ" >> $GITHUB_OUTPUT
          echo "flash_size=$FLASH_SIZE" >> $GITHUB_OUTPUT
          
          echo "Flash parameters: mode=$FLASH_MODE freq=$FLASH_FREQ size=$FLASH_SIZE"

      - name: Create merged-firmware.bin
        id: merge
        run: |
          set -euo pipefail
          BUILD_DIR=".pio/build/PM_V3"
          cd "$BUILD_DIR"
          
          # Verify required files
          for file in bootloader.bin partitions.bin firmware.bin; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing required file: $file"
              ls -lh .
              exit 1
            fi
          done
          
          echo "All required binaries present:"
          ls -lh bootloader.bin partitions.bin firmware.bin
          
          # Create merged binary with offsets from partition table
          esptool.py --chip esp32-s3 merge_bin \
            --flash_mode ${{ steps.flash_params.outputs.flash_mode }} \
            --flash_freq ${{ steps.flash_params.outputs.flash_freq }} \
            --flash_size ${{ steps.flash_params.outputs.flash_size }} \
            ${{ steps.offsets.outputs.bootloader_offset }} bootloader.bin \
            ${{ steps.offsets.outputs.partitions_offset }} partitions.bin \
            ${{ steps.offsets.outputs.app0_offset }} firmware.bin \
            -o merged-firmware.bin
          
          if [ ! -f merged-firmware.bin ]; then
            echo "ERROR: Failed to create merged-firmware.bin"
            exit 1
          fi
          
          echo "Successfully created merged-firmware.bin:"
          ls -lh merged-firmware.bin
          
          # Verify the merged binary is reasonable size
          SIZE=$(stat -f%z merged-firmware.bin 2>/dev/null || stat -c%s merged-firmware.bin)
          if [ "$SIZE" -lt 100000 ]; then
            echo "ERROR: merged-firmware.bin is suspiciously small ($SIZE bytes)"
            exit 1
          fi
          
          echo "Merged binary size: $SIZE bytes"
          cd - >/dev/null

      - name: Prepare firmware manifests
        run: |
          set -euo pipefail
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          
          # Use timestamped dev version for non-release builds
          if [ -z "$RELEASE_TAG" ]; then
            RELEASE_TAG="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          
          BUILD_DIR="$GITHUB_WORKSPACE/Code/PocketMage_V3/.pio/build/PM_V3"
          TARGET_DIR="$GITHUB_WORKSPACE/docs/firmware/${RELEASE_TAG}"
          mkdir -p "${TARGET_DIR}"
          
          # Copy firmware files
          cp "${BUILD_DIR}/merged-firmware.bin" "${TARGET_DIR}/merged-firmware.bin"
          cp "${BUILD_DIR}/firmware.bin" "${TARGET_DIR}/firmware.bin"
          
          echo "Firmware files copied to ${TARGET_DIR}"
          
          # Convert hex offset to decimal for JSON
          APP0_OFFSET="${{ steps.offsets.outputs.app0_offset }}"
          APP0_OFFSET_DEC=$((APP0_OFFSET))
          
          # Full installation manifest (includes bootloader + partitions)
          jq -n \
            --arg ver "$RELEASE_TAG" \
            '{
              name: "PocketMage Full Install",
              version: $ver,
              home_assistant_domain: "",
              new_install_prompt_erase: true,
              builds: [{
                chipFamily: "ESP32-S3",
                parts: [{
                  path: "merged-firmware.bin",
                  offset: 0
                }]
              }]
            }' > "${TARGET_DIR}/manifest.json"
          
          # Update-only manifest (app partition only, preserves NVS/SPIFFS)
          jq -n \
            --arg ver "$RELEASE_TAG" \
            --argjson offset "$APP0_OFFSET_DEC" \
            '{
              name: "PocketMage Update (Preserve Data)",
              version: $ver,
              home_assistant_domain: "",
              new_install_prompt_erase: false,
              builds: [{
                chipFamily: "ESP32-S3",
                parts: [{
                  path: "firmware.bin",
                  offset: $offset
                }]
              }]
            }' > "${TARGET_DIR}/manifest_no_erase.json"
          
          echo "Created manifest files for version: $RELEASE_TAG"
          echo "App partition offset: $APP0_OFFSET ($APP0_OFFSET_DEC decimal)"
          
          # Update or create version index
          INDEX_FILE="$GITHUB_WORKSPACE/docs/manifest-index.json"
          if [ -f "${INDEX_FILE}" ]; then
            jq --arg v "$RELEASE_TAG" \
              '(.versions // []) + [$v] | unique | sort_by(.) | reverse | {versions: .}' \
              "${INDEX_FILE}" > "${INDEX_FILE}.tmp"
            mv "${INDEX_FILE}.tmp" "${INDEX_FILE}"
          else
            jq -n --arg v "$RELEASE_TAG" '{versions: [$v]}' > "${INDEX_FILE}"
          fi
          
          echo "Updated manifest-index.json with version: $RELEASE_TAG"

      - name: Copy web flasher interface
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/docs"
          cp "$GITHUB_WORKSPACE/.github/index.html" "$GITHUB_WORKSPACE/docs/index.html"
          echo "Copied web flasher interface"

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4